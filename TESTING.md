# æ¸¬è©¦æŒ‡å—

## å®Œæ•´æ¸¬è©¦æµç¨‹

### 1. å•Ÿå‹•æœå‹™

```bash
# å•Ÿå‹•æ‰€æœ‰æœå‹™ï¼ˆæ•¸æ“šåº« + æ‡‰ç”¨ï¼‰
make up

# ç­‰å¾…æœå‹™å•Ÿå‹•ï¼ˆç´„ 30-60 ç§’ï¼‰
make logs

# çœ‹åˆ°é¡ä¼¼ä»¥ä¸‹æ—¥èªŒè¡¨ç¤ºå•Ÿå‹•æˆåŠŸï¼š
# Started SpringBootPrimaryReplicaDbApplication in X.XXX seconds
```

### 2. æ¸¬è©¦è®€å¯«åˆ†é›¢ï¼ˆå®Œæ•´æ¸¬è©¦ï¼‰

```bash
# é‹è¡Œå®Œæ•´æ¸¬è©¦è…³æœ¬
make test-rw

# æˆ–ç›´æ¥é‹è¡Œ
./test-rw-splitting.sh
```

**æ¸¬è©¦è…³æœ¬æœƒåŸ·è¡Œï¼š**
1. âœ… æœå‹™å¥åº·æª¢æŸ¥
2. âœ… æ•¸æ“šåº«é€£æ¥ä¿¡æ¯
3. âœ… å¯«æ“ä½œæ¸¬è©¦ï¼ˆæ‡‰è©²é€£æ¥ Primaryï¼‰
4. âœ… è®€æ“ä½œæ¸¬è©¦ï¼ˆæ‡‰è©²é€£æ¥ Replicaï¼‰
5. âœ… è² è¼‰å‡è¡¡æ¸¬è©¦ï¼ˆ10æ¬¡è®€å–ï¼‰
6. âœ… æ•¸æ“šä¸€è‡´æ€§æª¢æŸ¥

### 3. æŸ¥çœ‹å¯¦æ™‚æ—¥èªŒï¼ˆæ¨è–¦ï¼‰

åœ¨ä¸€å€‹çµ‚ç«¯é‹è¡Œï¼š
```bash
make watch-logs
```

åœ¨å¦ä¸€å€‹çµ‚ç«¯åŸ·è¡Œæ¸¬è©¦ï¼š
```bash
curl http://localhost:8080/api/users
```

**æ—¥èªŒè¼¸å‡ºç¤ºä¾‹ï¼š**
```
ğŸ“– AOP æª¢æ¸¬åˆ°è®€æ“ä½œ: UserService.getAllUsers(..)
ğŸŸ¢ è·¯ç”±æ±ºç­–: READ â†’ SLAVE1 (Port: 5433)
```

## æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ

### æ¸¬è©¦ 1ï¼šå¯«æ“ä½œï¼ˆPrimaryï¼‰

```bash
# å‰µå»ºç”¨æˆ¶
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john_doe",
    "email": "john@example.com",
    "firstName": "John",
    "lastName": "Doe"
  }'
```

**é æœŸçµæœï¼š**
- æ—¥èªŒé¡¯ç¤ºï¼š`ğŸ”µ è·¯ç”±æ±ºç­–: WRITE â†’ Primary Database (MASTER:5432)`
- è¿”å›å‰µå»ºçš„ç”¨æˆ¶ä¿¡æ¯

### æ¸¬è©¦ 2ï¼šè®€æ“ä½œï¼ˆReplicaï¼‰

```bash
# è®€å–æ‰€æœ‰ç”¨æˆ¶
curl http://localhost:8080/api/users
```

**é æœŸçµæœï¼š**
- æ—¥èªŒé¡¯ç¤ºï¼š`ğŸŸ¢ è·¯ç”±æ±ºç­–: READ â†’ SLAVE1 (Port: 5433)` æˆ– `SLAVE2 (Port: 5434)`
- è¿”å›æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨

### æ¸¬è©¦ 3ï¼šè² è¼‰å‡è¡¡

```bash
# é€£çºŒè®€å–10æ¬¡
for i in {1..10}; do 
  echo "=== Read #$i ==="
  curl -s http://localhost:8080/api/users | jq '. | length'
done
```

**é æœŸçµæœï¼š**
- æ—¥èªŒæœƒé¡¯ç¤ºéš¨æ©Ÿåˆ‡æ›åœ¨ Replica1 å’Œ Replica2 ä¹‹é–“
- éš¨æ©Ÿæ€§ï¼šç´„ 50% SLAVE1ï¼Œ50% SLAVE2

### æ¸¬è©¦ 4ï¼šæ›´æ–°æ“ä½œï¼ˆPrimaryï¼‰

```bash
# æ›´æ–°ç”¨æˆ¶ï¼ˆæ³¨æ„ï¼šæ›¿æ› {id} ç‚ºå¯¦éš›ç”¨æˆ¶ IDï¼‰
curl -X PUT http://localhost:8080/api/users/1 \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john_updated",
    "email": "john.updated@example.com",
    "firstName": "John",
    "lastName": "Smith"
  }'
```

**é æœŸçµæœï¼š**
- æ—¥èªŒé¡¯ç¤ºï¼š`ğŸ”µ è·¯ç”±æ±ºç­–: WRITE â†’ Primary Database (MASTER:5432)`

### æ¸¬è©¦ 5ï¼šæ•¸æ“šåº«é©—è­‰

```bash
# åœ¨ Primary æŸ¥çœ‹æ•¸æ“š
make shell-db-primary
SELECT COUNT(*) FROM users;
SELECT * FROM users;

# åœ¨ Replica1 æŸ¥çœ‹æ•¸æ“š
make shell-db-replica1
SELECT COUNT(*) FROM users;

# åœ¨ Replica2 æŸ¥çœ‹æ•¸æ“š
make shell-db-replica2
SELECT COUNT(*) FROM users;
```

## é©—è­‰è¦é»

### âœ… å¯«æ“ä½œé©—è­‰

1. **æ—¥èªŒé¡¯ç¤º**ï¼š`ğŸ”µ è·¯ç”±æ±ºç­–: WRITE â†’ Primary Database (MASTER:5432)`
2. **æ•¸æ“šåº«**ï¼šPrimary æ‡‰è©²æœ‰æ–°æ•¸æ“š
3. **ç‹€æ…‹ç¢¼**ï¼šHTTP 201 (å‰µå»º) æˆ– 200 (æ›´æ–°)

### âœ… è®€æ“ä½œé©—è­‰

1. **æ—¥èªŒé¡¯ç¤º**ï¼š`ğŸŸ¢ è·¯ç”±æ±ºç­–: READ â†’ SLAVE1` æˆ– `SLAVE2`
2. **è² è¼‰å‡è¡¡**ï¼šå¤šæ¬¡è®€å–æ‡‰åœ¨å…©å€‹ Replica é–“éš¨æ©Ÿ
3. **ç‹€æ…‹ç¢¼**ï¼šHTTP 200

### âœ… AOP é©—è­‰

1. **æ—¥èªŒé¡¯ç¤º**ï¼š`ğŸ“ AOP æª¢æ¸¬åˆ°å¯«æ“ä½œ` æˆ– `ğŸ“– AOP æª¢æ¸¬åˆ°è®€æ“ä½œ`
2. **æ–¹æ³•å**ï¼šé¡¯ç¤ºæ­£åœ¨åŸ·è¡Œçš„æ–¹æ³•

## å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1ï¼šæ—¥èªŒæ²’æœ‰é¡¯ç¤ºè·¯ç”±ä¿¡æ¯

**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
# ç¢ºä¿æ—¥èªŒç´šåˆ¥æ­£ç¢º
# æª¢æŸ¥ application.yml ä¸­çš„ logging.level

# é‡æ–°æ§‹å»º
make rebuild
```

### å•é¡Œ 2ï¼šç¸½æ˜¯é€£æ¥åˆ° Primary

**æª¢æŸ¥ï¼š**
1. `@Transactional(readOnly = true)` æ˜¯å¦æ­£ç¢ºè¨­ç½®
2. AOP æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. DataSourceAspect æ˜¯å¦è¢« Spring æƒæ

### å•é¡Œ 3ï¼šç„¡æ³•é€£æ¥ Replica

**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
# æª¢æŸ¥ Replica å®¹å™¨ç‹€æ…‹
docker ps | grep replica

# æª¢æŸ¥ Replica æ—¥èªŒ
docker logs postgres-replica1
docker logs postgres-replica2
```

## å®Œæ•´æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] æœå‹™å•Ÿå‹•æˆåŠŸ
- [ ] å¥åº·æª¢æŸ¥é€šé
- [ ] å¯«æ“ä½œé€£æ¥åˆ° Primary
- [ ] è®€æ“ä½œé€£æ¥åˆ° Replica
- [ ] è®€æ“ä½œåœ¨å…©å€‹ Replica é–“è² è¼‰å‡è¡¡
- [ ] æ—¥èªŒé¡¯ç¤ºæ­£ç¢ºçš„è·¯ç”±æ±ºç­–
- [ ] AOP æ­£ç¢ºæ””æˆªäº‹å‹™æ–¹æ³•
- [ ] æ•¸æ“šèƒ½å¤ æ­£ç¢ºå‰µå»ºå’Œè®€å–

## æ¸¬è©¦å ±å‘Šæ¨¡æ¿

```
æ¸¬è©¦æ—¥æœŸ: YYYY-MM-DD
æ¸¬è©¦äººå“¡: Your Name

âœ… å¯«æ“ä½œæ¸¬è©¦
- POST /api/users: æˆåŠŸ
- PUT /api/users/{id}: æˆåŠŸ
- è·¯ç”±: Primary (5432)

âœ… è®€æ“ä½œæ¸¬è©¦
- GET /api/users: æˆåŠŸ
- GET /api/users/{id}: æˆåŠŸ
- è·¯ç”±: Replica1 (5433) æˆ– Replica2 (5434)

âœ… è² è¼‰å‡è¡¡æ¸¬è©¦
- 10æ¬¡è®€å–æ¸¬è©¦: æˆåŠŸ
- SLAVE1 ä½¿ç”¨æ¬¡æ•¸: X
- SLAVE2 ä½¿ç”¨æ¬¡æ•¸: 10-X

âœ… åŠŸèƒ½æ¸¬è©¦
- ç”¨æˆ¶å‰µå»º: æˆåŠŸ
- ç”¨æˆ¶æŸ¥è©¢: æˆåŠŸ
- ç”¨æˆ¶æ›´æ–°: æˆåŠŸ
- ç”¨æˆ¶åˆªé™¤: æˆåŠŸ

çµè«–: è®€å¯«åˆ†é›¢æ­£å¸¸å·¥ä½œ
```

## æ¸¬è©¦è…³æœ¬ä½¿ç”¨èªªæ˜

### test-rw-splitting.sh

å®Œæ•´æ¸¬è©¦è…³æœ¬ï¼ŒåŒ…å«æ‰€æœ‰æ¸¬è©¦å ´æ™¯ã€‚

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
./test-rw-splitting.sh
```

**åŠŸèƒ½ï¼š**
- è‡ªå‹•æª¢æ¸¬æœå‹™ç‹€æ…‹
- åŸ·è¡Œæ‰€æœ‰è®€å¯«æ¸¬è©¦
- é©—è­‰è² è¼‰å‡è¡¡
- æª¢æŸ¥æ•¸æ“šä¸€è‡´æ€§
- æ¸…ç†æ¸¬è©¦æ•¸æ“šï¼ˆå¯é¸ï¼‰

### test-api.sh

åŸºç¤ API æ¸¬è©¦è…³æœ¬ã€‚

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
./test-api.sh
```

## æŒçºŒç›£æ§

### å¯¦æ™‚ç›£æ§è®€å¯«åˆ†é›¢

```bash
# çµ‚ç«¯ 1ï¼šç›£æ§æ—¥èªŒ
make watch-logs

# çµ‚ç«¯ 2ï¼šåŸ·è¡Œæ¸¬è©¦
for i in {1..100}; do
  curl -s http://localhost:8080/api/users > /dev/null
  sleep 0.1
done
```

### çµ±è¨ˆè·¯ç”±åˆ†å¸ƒ

```bash
# æ”¶é›† 100 æ¬¡è®€å–çš„æ—¥èªŒ
make watch-logs 2>&1 | grep "è·¯ç”±æ±ºç­–" | tee routing.log

# çµ±è¨ˆ Primary vs Replica ä½¿ç”¨æ¬¡æ•¸
cat routing.log | grep -c "Primary"
cat routing.log | grep -c "SLAVE"
```

## é€²éšæ¸¬è©¦

### æ¸¬è©¦ä¸¦ç™¼è®€å¯«

```bash
# åŒæ™‚åŸ·è¡Œå¤šå€‹è®€å¯«æ“ä½œ
seq 1 10 | xargs -n1 -P10 -I{} sh -c '
  curl -X POST http://localhost:8080/api/users \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"user_{}\",\"email\":\"user{}@test.com\",\"firstName\":\"User\",\"lastName\":\"{}\"}"
'
```

### å£“åŠ›æ¸¬è©¦

```bash
# ä½¿ç”¨ apache bench æ¸¬è©¦
ab -n 1000 -c 10 http://localhost:8080/api/users
```

## ç¸½çµ

æŒ‰ç…§ä¸Šè¿°æ­¥é©Ÿé€²è¡Œæ¸¬è©¦ï¼Œå¯ä»¥ç¢ºä¿ï¼š
1. âœ… è®€å¯«åˆ†é›¢æ­£ç¢ºå·¥ä½œ
2. âœ… è² è¼‰å‡è¡¡æ­£å¸¸
3. âœ… AOP æ­£ç¢ºæ””æˆª
4. âœ… æ•¸æ“šä¸€è‡´æ€§

å¦‚æœæ‰€æœ‰æ¸¬è©¦é€šéï¼Œèªªæ˜è®€å¯«åˆ†é›¢åŠŸèƒ½æ­£å¸¸é‹ä½œï¼

